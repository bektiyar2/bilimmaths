<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilimMath ‚Äî Global Multilingual</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5341/5341426.png">
    <meta name="theme-color" content="#5D5FEF">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .math-card { box-shadow: 0 20px 60px rgba(93, 95, 239, 0.15); border-radius: 40px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .rank-gold { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; }
    </style>
</head>
<body class="bg-[#F4F7FF] min-h-screen flex items-center justify-center p-4">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDYcopzuJzFYm2T0-GonGA4YQqpzz5egxw",
            authDomain: "bilimmath-a3e1e.firebaseapp.com",
            projectId: "bilimmath-a3e1e",
            storageBucket: "bilimmath-a3e1e.firebasestorage.app",
            messagingSenderId: "1016139764877",
            appId: "1:1016139764877:web:f9de05ef243efb41823ec4",
            databaseURL: "https://bilimmath-a3e1e-default-rtdb.europe-west1.firebasedatabase.app"
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        const taskGenerators = {
            // 1 –ö–õ–ê–°–°: –ß–∏—Å–ª–∞ 0-20, —Å–ª–æ–∂–µ–Ω–∏–µ/–≤—ã—á–∏—Ç–∞–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –¥–µ—Å—è—Ç–æ–∫ –∏ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º, –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ
            1: [
                { id: 'add10', kk: '“ö–æ—Å—É (20-“ì–∞ –¥–µ–π—ñ–Ω)', ru: '–°–ª–æ–∂–µ–Ω–∏–µ (–¥–æ 20)', gen: () => { const a=randomInt(1,10), b=randomInt(1,10); return { q: {kk:`${a} + ${b}`, ru:`${a} + ${b}`}, ans: a+b }; } },
                { id: 'sub10', kk: '–ê–∑–∞–π—Ç—É (20-“ì–∞ –¥–µ–π—ñ–Ω)', ru: '–í—ã—á–∏—Ç–∞–Ω–∏–µ (–¥–æ 20)', gen: () => { const a=randomInt(5,20), b=randomInt(1,a); return { q: {kk:`${a} - ${b}`, ru:`${a} - ${b}`}, ans: a-b }; } },
                { id: 'unknown', kk: '–ë–µ–ª–≥—ñ—Å—ñ–∑ —Å–∞–Ω', ru: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —á–∏—Å–ª–æ', gen: () => { const a=randomInt(1,10), res=randomInt(11,20); return { q: {kk:`${a} + x = ${res}`, ru:`${a} + x = ${res}`}, ans: res-a }; } },
                { id: 'comp', kk: '–°–∞–ª—ã—Å—Ç—ã—Ä—É', ru: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ (—Å—É–º–º–∞)', gen: () => { const a=randomInt(1,5), b=randomInt(1,5), c=randomInt(1,3); return { q: {kk:`${a}+${b}+${c}`, ru:`${a}+${b}+${c}`}, ans: a+b+c }; } }
            ],
            // 2 –ö–õ–ê–°–°: –ß–∏—Å–ª–∞ –¥–æ 100, —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è (–Ω–∞—á–∞–ª–æ), —Å–∫–æ–±–∫–∏
            2: [
                { id: 'add100', kk: '“ö–æ—Å—É (100-–≥–µ –¥–µ–π—ñ–Ω)', ru: '–°–ª–æ–∂–µ–Ω–∏–µ (–¥–æ 100)', gen: () => { const a=randomInt(10,50), b=randomInt(10,40); return { q: {kk:`${a} + ${b}`, ru:`${a} + ${b}`}, ans: a+b }; } },
                { id: 'sub100', kk: '–ê–∑–∞–π—Ç—É (100-–≥–µ –¥–µ–π—ñ–Ω)', ru: '–í—ã—á–∏—Ç–∞–Ω–∏–µ (–¥–æ 100)', gen: () => { const a=randomInt(50,99), b=randomInt(10,40); return { q: {kk:`${a} - ${b}`, ru:`${a} - ${b}`}, ans: a-b }; } },
                { id: 'mult_easy', kk: '–ö”©–±–µ–π—Ç—É –∫–µ—Å—Ç–µ—Å—ñ (2-5)', ru: '–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è (2-5)', gen: () => { const a=randomInt(2,5), b=randomInt(2,9); return { q: {kk:`${a} ¬∑ ${b}`, ru:`${a} ¬∑ ${b}`}, ans: a*b }; } },
                { id: 'brackets', kk: '–ñ–∞“õ—à–∞–ª–∞—Ä', ru: '–°–∫–æ–±–∫–∏', gen: () => { const a=randomInt(10,20), b=randomInt(1,5), c=randomInt(1,5); return { q: {kk:`${a} - (${b} + ${c})`, ru:`${a} - (${b} + ${c})`}, ans: a-(b+c) }; } }
            ],
            // 3 –ö–õ–ê–°–°: –£–º–Ω–æ–∂–µ–Ω–∏–µ/–¥–µ–ª–µ–Ω–∏–µ (–ø–æ–ª–Ω–æ–µ), —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø–µ—Ä–∏–º–µ—Ç—Ä/–ø–ª–æ—â–∞–¥—å
            3: [
                { id: 'mult_hard', kk: '–ö”©–±–µ–π—Ç—É –∫–µ—Å—Ç–µ—Å—ñ (6-9)', ru: '–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è (6-9)', gen: () => { const a=randomInt(6,9), b=randomInt(2,9); return { q: {kk:`${a} ¬∑ ${b}`, ru:`${a} ¬∑ ${b}`}, ans: a*b }; } },
                { id: 'div_easy', kk: '“ö–∞–ª–¥—ã“õ—Å—ã–∑ –±”©–ª—É', ru: '–î–µ–ª–µ–Ω–∏–µ –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞', gen: () => { const b=randomInt(2,9), ans=randomInt(2,9); const a=b*ans; return { q: {kk:`${a} : ${b}`, ru:`${a} : ${b}`}, ans: ans }; } },
                { id: 'eq_mult', kk: '–ö“Ø—Ä–¥–µ–ª—ñ —Ç–µ“£–¥–µ—É', ru: '–°–ª–æ–∂–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ', gen: () => { const x=randomInt(2,9), m=randomInt(2,5); return { q: {kk:`x ¬∑ ${m} = ${x*m}`, ru:`x ¬∑ ${m} = ${x*m}`}, ans: x }; } },
                { id: 'geom_p', kk: '–ü–µ—Ä–∏–º–µ—Ç—Ä (P)', ru: '–ü–µ—Ä–∏–º–µ—Ç—Ä (P)', gen: () => { const a=randomInt(3,8), b=randomInt(3,8); return { q: {kk:`a=${a}, b=${b}. P=?`, ru:`a=${a}, b=${b}. P=?`}, ans: (a+b)*2 }; } }
            ],
            // 4 –ö–õ–ê–°–°: –ú–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã–µ —á–∏—Å–ª–∞, —Å–∫–æ—Ä–æ—Å—Ç—å/–≤—Ä–µ–º—è/—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –ø–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
            4: [
                { id: 'long_add', kk: '–ö”©–ø—Ç–∞“£–±–∞–ª—ã —Å–∞–Ω–¥–∞—Ä', ru: '–ú–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã–µ —á–∏—Å–ª–∞', gen: () => { const a=randomInt(100,500), b=randomInt(100,500); return { q: {kk:`${a} + ${b}`, ru:`${a} + ${b}`}, ans: a+b }; } },
                { id: 'speed', kk: '“ö–æ–∑“ì–∞–ª—ã—Å (S=v¬∑t)', ru: '–î–≤–∏–∂–µ–Ω–∏–µ (S=v¬∑t)', gen: () => { const v=randomInt(40,80), t=randomInt(2,5); return { q: {kk:`v=${v}, t=${t}. S=?`, ru:`v=${v}, t=${t}. S=?`}, ans: v*t }; } },
                { id: 'order', kk: '–ê–º–∞–ª–¥–∞—Ä –æ—Ä—ã–Ω–¥–∞–ª—É—ã', ru: '–ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π', gen: () => { const a=randomInt(2,5), b=randomInt(10,20), c=randomInt(2,5); return { q: {kk:`${b} + ${a} ¬∑ ${c}`, ru:`${b} + ${a} ¬∑ ${c}`}, ans: b+(a*c) }; } },
                { id: 'div_long', kk: '–ë”©–ª—É (–∂“Ø–∑–¥—ñ–∫—Ç–µ—Ä)', ru: '–î–µ–ª–µ–Ω–∏–µ (—Å–æ—Ç–Ω–∏)', gen: () => { const ans=randomInt(11,50), b=randomInt(2,9); return { q: {kk:`${ans*b} : ${b}`, ru:`${ans*b} : ${b}`}, ans: ans }; } }
            ],
            // 5 –ö–õ–ê–°–°: –î–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏, —Å—Ç–µ–ø–µ–Ω–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, —É–≥–ª—ã (–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞)
            5: [
                { id: 'pow2', kk: '–°–∞–Ω–Ω—ã“£ –∫–≤–∞–¥—Ä–∞—Ç—ã', ru: '–ö–≤–∞–¥—Ä–∞—Ç —á–∏—Å–ª–∞', gen: () => { const a=randomInt(2,12); return { q: {kk:`${a}¬≤`, ru:`${a}¬≤`}, ans: a*a }; } },
                { id: 'pow3', kk: '–°–∞–Ω–Ω—ã“£ –∫—É–±—ã', ru: '–ö—É–± —á–∏—Å–ª–∞', gen: () => { const a=randomInt(2,6); return { q: {kk:`${a}¬≥`, ru:`${a}¬≥`}, ans: a*a*a }; } },
                { id: 'perc', kk: '–ü–∞–π—ã–∑ (%)', ru: '–ü—Ä–æ—Ü–µ–Ω—Ç—ã (%)', gen: () => { const n=randomInt(1,20)*10; return { q: {kk:`${n}-–¥—ñ“£ 20%-—ã?`, ru:`20% –æ—Ç ${n}?`}, ans: n*0.2 }; } },
                { id: 'dec_add', kk: '–û–Ω–¥—ã“õ –±”©–ª—à–µ–∫—Ç–µ—Ä', ru: '–î–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏', gen: () => { const a=randomInt(1,10), b=randomInt(1,10); return { q: {kk:`${a/10} + ${b/10}`, ru:`${a/10} + ${b/10}`}, ans: (a+b)/10 }; } }
            ],
            // 6 –ö–õ–ê–°–°: –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ), –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, –º–æ–¥—É–ª—å
            6: [
                { id: 'neg_add', kk: '–¢–µ—Ä—ñ—Å —Å–∞–Ω–¥–∞—Ä–¥—ã “õ–æ—Å—É', ru: '–°–ª–æ–∂. –æ—Ç—Ä–∏—Ü. —á–∏—Å–µ–ª', gen: () => { const a=randomInt(1,20), b=randomInt(1,20); return { q: {kk:`(-${a}) + (-${b})`, ru:`(-${a}) + (-${b})`}, ans: -(a+b) }; } },
                { id: 'neg_mult', kk: '–¢–∞“£–±–∞–ª–∞—Ä –µ—Ä–µ–∂–µ—Å—ñ', ru: '–ü—Ä–∞–≤–∏–ª–æ –∑–Ω–∞–∫–æ–≤ (x)', gen: () => { const a=randomInt(2,10), b=randomInt(2,10); return { q: {kk:`(-${a}) ¬∑ (-${b})`, ru:`(-${a}) ¬∑ (-${b})`}, ans: a*b }; } },
                { id: 'prop', kk: '–ü—Ä–æ–ø–æ—Ä—Ü–∏—è', ru: '–ü—Ä–æ–ø–æ—Ä—Ü–∏—è', gen: () => { const x=randomInt(2,10), k=randomInt(2,5); return { q: {kk:`x : ${k} = ${x*2} : ${k*2}`, ru:`x : ${k} = ${x*2} : ${k*2}`}, ans: x }; } },
                { id: 'abs', kk: '–ú–æ–¥—É–ª—å', ru: '–ú–æ–¥—É–ª—å', gen: () => { const a=randomInt(-50,-10); return { q: {kk:`|${a}| - 10`, ru:`|${a}| - 10`}, ans: Math.abs(a)-10 }; } }
            ],
            // 7 –ö–õ–ê–°–°: –ê–ª–≥–µ–±—Ä–∞ (—Ñ–æ—Ä–º—É–ª—ã —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–≥–æ —É–º–Ω–æ–∂–µ–Ω–∏—è, —Ñ—É–Ω–∫—Ü–∏–∏), —Å—Ç–µ–ø–µ–Ω–∏
            7: [
                { id: 'lin_eq', kk: '–°—ã–∑—ã“õ—Ç—ã“õ —Ç–µ“£–¥–µ—É', ru: '–õ–∏–Ω–µ–π–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ', gen: () => { const x=randomInt(-10,10), b=randomInt(1,20); return { q: {kk:`2x + ${b} = ${2*x+b}`, ru:`2x + ${b} = ${2*x+b}`}, ans: x }; } },
                { id: 'pow_props', kk: '–î”ô—Ä–µ–∂–µ “õ–∞—Å–∏–µ—Ç—Ç–µ—Ä—ñ', ru: '–°–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–µ–ø–µ–Ω–µ–π', gen: () => { const n=randomInt(2,5); return { q: {kk:`2¬≥ ¬∑ 2^${n} = 2^x`, ru:`2¬≥ ¬∑ 2^${n} = 2^x`}, ans: 3+n }; } },
                { id: 'func_val', kk: '–§—É–Ω–∫—Ü–∏—è –º”ô–Ω—ñ y=kx+b', ru: '–ó–Ω–∞—á–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü. y=kx+b', gen: () => { const x=randomInt(1,5), k=randomInt(2,4), b=randomInt(1,10); return { q: {kk:`y=${k}x+${b}, x=${x}. y=?`, ru:`y=${k}x+${b}, x=${x}. y=?`}, ans: k*x+b }; } },
                { id: 'fsu', kk: '“ö—ã—Å“õ–∞—à–∞ –∫”©–±–µ–π—Ç—É (a¬≤-b¬≤)', ru: '–§–°–£ (a¬≤-b¬≤)', gen: () => { const a=randomInt(5,10); return { q: {kk:`${a}¬≤ - ${a-1}¬≤`, ru:`${a}¬≤ - ${a-1}¬≤`}, ans: (a*a) - ((a-1)*(a-1)) }; } }
            ],
            // 8 –ö–õ–ê–°–°: –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–æ—Ä–Ω–∏, –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, —Ç–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞
            8: [
                { id: 'sqrt', kk: '–ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞–ª—ã“õ —Ç“Ø–±—ñ—Ä', ru: '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å', gen: () => { const n=randomInt(2,20); return { q: {kk:`‚àö${n*n}`, ru:`‚àö${n*n}`}, ans: n }; } },
                { id: 'quad_eq_simple', kk: 'x¬≤ = a', ru: '–£—Ä–∞–≤–Ω–µ–Ω–∏–µ x¬≤ = a', gen: () => { const x=randomInt(2,15); return { q: {kk:`x¬≤ = ${x*x} (x>0)`, ru:`x¬≤ = ${x*x} (x>0)`}, ans: x }; } },
                { id: 'pythag', kk: '–ü–∏—Ñ–∞–≥–æ—Ä —Ç–µ–æ—Ä–µ–º–∞—Å—ã', ru: '–¢–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞', gen: () => { return { q: {kk:`a=3, b=4, c=?`, ru:`a=3, b=4, c=?`}, ans: 5 }; } }, // –°—Ç–∞—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ç—Ä–æ–π–∫–∞–º–∏
                { id: 'discr', kk: '–î–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç D', ru: '–î–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç D', gen: () => { const b=randomInt(4,10), a=1, c=2; return { q: {kk:`x¬≤ + ${b}x + ${c} = 0. D=?`, ru:`x¬≤ + ${b}x + ${c} = 0. D=?`}, ans: b*b - 4*a*c }; } }
            ],
            // 9 –ö–õ–ê–°–°: –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∞—è/–ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏, —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è, –≤–µ–∫—Ç–æ—Ä—ã
            9: [
                { id: 'arith_prog', kk: '–ê—Ä–∏—Ñ–º. –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è', ru: '–ê—Ä–∏—Ñ–º. –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è', gen: () => { const a1=randomInt(1,10), d=randomInt(2,5); return { q: {kk:`a‚ÇÅ=${a1}, d=${d}. a‚ÇÑ=?`, ru:`a‚ÇÅ=${a1}, d=${d}. a‚ÇÑ=?`}, ans: a1 + 3*d }; } },
                { id: 'geom_prog', kk: '–ì–µ–æ–º. –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è', ru: '–ì–µ–æ–º. –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è', gen: () => { const b1=randomInt(1,3), q=2; return { q: {kk:`b‚ÇÅ=${b1}, q=2. b‚ÇÑ=?`, ru:`b‚ÇÅ=${b1}, q=2. b‚ÇÑ=?`}, ans: b1 * 8 }; } },
                { id: 'fact', kk: '–§–∞–∫—Ç–æ—Ä–∏–∞–ª', ru: '–§–∞–∫—Ç–æ—Ä–∏–∞–ª', gen: () => { const n=randomInt(3,5); const fact = (num) => num <= 1 ? 1 : num * fact(num - 1); return { q: {kk:`${n}!`, ru:`${n}!`}, ans: fact(n) }; } },
                { id: 'trig', kk: '–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', ru: '–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è', gen: () => { return { q: {kk:`2 ¬∑ sin(30¬∞)`, ru:`2 ¬∑ sin(30¬∞)`}, ans: 1 }; } } // sin30=0.5, –æ—Ç–≤–µ—Ç 1
            ]
        };

        const App = () => {
            const [lang, setLang] = useState('kk');
            const [user, setUser] = useState(localStorage.getItem('bilim_user') || '');
            const [tempName, setTempName] = useState('');
            const [grade, setGrade] = useState(1);
            const [topicId, setTopicId] = useState('all');
            const [problem, setProblem] = useState(null);
            const [answer, setAnswer] = useState('');
            const [isCorrect, setIsCorrect] = useState(null);
            const [leaders, setLeaders] = useState([]);
            const [showRank, setShowRank] = useState(false);
            const inputRef = useRef(null); // –†–µ—Ñ –¥–ª—è —Ñ–æ–∫—É—Å–∞

            useEffect(() => {
                const leadersRef = db.ref('users');
                leadersRef.on('value', (snap) => {
                    if (snap.exists()) {
                        const list = Object.values(snap.val()).sort((a, b) => b.score - a.score);
                        setLeaders(list);
                    }
                });
            }, []);

            const generate = (g = grade, tId = topicId) => {
                const topics = taskGenerators[g];
                let selected = tId === 'all' ? topics[randomInt(0, topics.length - 1)] : topics.find(x => x.id === tId);
                if (!selected) selected = topics[0];
                const data = selected.gen();
                setProblem({ ...data, topicName: {kk: selected.kk, ru: selected.ru} });
                setTimeout(() => inputRef.current?.focus(), 100); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å
            };

            useEffect(() => { if(user) generate(grade, 'all'); setTopicId('all'); }, [grade, user]);

            const check = () => {
                if (!answer || isCorrect !== null) return;
                const correct = parseFloat(answer) === problem.ans;
                setIsCorrect(correct);
                if (correct) {
                    db.ref('users/' + user).transaction(d => {
                        if (d) { d.score += 10; return d; }
                        return { name: user, score: 10 };
                    });
                }
                setTimeout(() => { generate(); setAnswer(''); setIsCorrect(null); }, 1300);
            };

            const t = {
                kk: { welcome: "–ï—Å—ñ–º—ñ“£–¥—ñ –∂–∞–∑:", start: "–ë–∞—Å—Ç–∞—É", rank: "–†–ï–ô–¢–ò–ù–ì", score: "“∞–ø–∞–π", check: "–¢–ï–ö–°–ï–†–£", yes: "–î“∞–†–´–°!", no: "“ö–ê–¢–ï!", all: "–ë–ê–†–õ–´“í–´" },
                ru: { welcome: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è:", start: "–ù–∞—á–∞—Ç—å", rank: "–†–ï–ô–¢–ò–ù–ì", score: "–ë–∞–ª–ª—ã", check: "–ü–†–û–í–ï–†–ò–¢–¨", yes: "–í–ï–†–ù–û!", no: "–û–®–ò–ë–ö–ê!", all: "–í–°–ï –¢–ï–ú–´" }
            }[lang];

            if (!user) {
                return (
                    <div className="math-card bg-white w-full max-w-[400px] p-10">
                        <h1 className="text-3xl font-black text-[#5D5FEF] mb-6">BilimMath</h1>
                        <p className="text-gray-400 mb-4 text-sm font-bold uppercase tracking-widest">{t.welcome}</p>
                        <input value={tempName} onChange={e => setTempName(e.target.value)} className="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl p-4 mb-4 outline-none focus:border-[#5D5FEF] font-bold text-lg" placeholder="..." />
                        <button onClick={() => { if(tempName.trim()){ setUser(tempName.trim()); localStorage.setItem('bilim_user', tempName.trim()); db.ref('users/'+tempName.trim()).once('value', s => { if(!s.exists()) db.ref('users/'+tempName.trim()).set({name: tempName.trim(), score: 0}); }); } }} className="w-full bg-[#5D5FEF] text-white py-4 rounded-2xl font-black shadow-lg"> {t.start} </button>
                    </div>
                );
            }

            if (showRank) {
                return (
                    <div className="math-card bg-white w-full max-w-[400px] p-8 h-[550px] flex flex-col">
                        <div className="flex justify-between items-center mb-6 text-gray-800">
                            <h2 className="text-2xl font-black italic">üèÜ {t.rank}</h2>
                            <button onClick={() => setShowRank(false)} className="text-[#5D5FEF] font-bold text-sm uppercase">–ù–∞–∑–∞–¥</button>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar">
                            {leaders.map((p, i) => (
                                <div key={i} className={`flex justify-between items-center p-4 rounded-2xl mb-2 ${p.name === user ? 'bg-indigo-50 border border-indigo-100' : 'bg-gray-50'}`}>
                                    <div className="flex items-center gap-3">
                                        <span className={`w-8 h-8 flex items-center justify-center rounded-full font-black text-xs ${i === 0 ? 'rank-gold' : 'bg-gray-200'}`}>{i+1}</span>
                                        <span className="font-bold text-gray-700">{p.name}</span>
                                    </div>
                                    <span className="font-black text-[#5D5FEF]">{p.score}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className="math-card bg-white w-full max-w-[480px] p-8">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-[#5D5FEF] text-xl font-black">BilimMath <span className="text-[10px] text-gray-300 ml-1">KZ</span></h1>
                            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-tighter italic">{user}</p>
                        </div>
                        <div className="flex gap-2">
                             <button onClick={() => setShowRank(true)} className="bg-gray-50 px-3 py-2 rounded-xl text-[10px] font-black text-[#5D5FEF] border border-gray-100 uppercase tracking-widest">{t.rank}</button>
                             <div className="flex bg-gray-50 p-1 rounded-xl text-[10px] font-bold border border-gray-100">
                                <button onClick={() => setLang('kk')} className={`px-2 py-1 rounded-lg ${lang === 'kk' ? 'bg-white text-[#5D5FEF] shadow-sm' : 'text-gray-300'}`}>KK</button>
                                <button onClick={() => setLang('ru')} className={`px-2 py-1 rounded-lg ${lang === 'ru' ? 'bg-white text-[#5D5FEF] shadow-sm' : 'text-gray-300'}`}>RU</button>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-5 gap-2 mb-6">
                        {[1,2,3,4,5,6,7,8,9].map(g => (
                            <button key={g} onClick={() => setGrade(g)} className={`py-3 rounded-2xl font-black text-xs transition ${grade === g ? 'bg-[#5D5FEF] text-white shadow-lg' : 'bg-[#F2F6FF] text-[#5D5FEF]'}`}>{g}</button>
                        ))}
                    </div>

                    <div className="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-1">
                        <button onClick={() => {setTopicId('all'); generate(grade, 'all');}} className={`px-4 py-2 rounded-full text-[10px] font-black tracking-wider whitespace-nowrap transition ${topicId === 'all' ? 'bg-[#5D5FEF] text-white' : 'bg-gray-50 text-gray-400'}`}>{t.all}</button>
                        {taskGenerators[grade].map(topic => (
                            <button key={topic.id} onClick={() => {setTopicId(topic.id); generate(grade, topic.id);}} className={`px-4 py-2 rounded-full text-[10px] font-black tracking-wider whitespace-nowrap transition ${topicId === topic.id ? 'bg-[#5D5FEF] text-white' : 'bg-gray-50 text-gray-400'}`}>{topic[lang].toUpperCase()}</button>
                        ))}
                    </div>

                    <div className="bg-[#F9FBFF] rounded-[40px] p-10 text-center mb-6 border border-indigo-50/50">
                        <p className="text-[#A5B4FC] font-black tracking-[0.2em] text-[9px] mb-3 uppercase">{problem?.topicName[lang]}</p>
                        <h2 className="text-4xl font-black text-[#2D3142]">{problem?.q[lang]} = ?</h2>
                    </div>

                    <input ref={inputRef} type="number" inputMode="decimal" value={answer} onChange={e => setAnswer(e.target.value)} onKeyDown={e => e.key === 'Enter' && check()} className="w-full bg-[#F2F6FF] rounded-[24px] py-6 text-center text-4xl font-black text-[#5D5FEF] mb-6 outline-none border-4 border-transparent focus:border-indigo-100 transition-all placeholder:text-indigo-100" placeholder="?" />

                    <button onClick={check} disabled={isCorrect !== null} className={`w-full py-6 rounded-[24px] text-white font-black text-xl shadow-xl transition-all active:scale-95 ${isCorrect === true ? 'bg-green-500' : isCorrect === false ? 'bg-red-500' : 'bg-[#5D5FEF]'}`}>
                        {isCorrect === true ? t.yes : isCorrect === false ? t.no : t.check}
                    </button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // –®–ê–ì 3: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
            });
        }
    </script>
</body>
</html>

